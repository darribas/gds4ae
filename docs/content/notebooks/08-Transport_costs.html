
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transport costs &#8212; Geographic Data Science for Applied Economists</title>
    
  <link rel="stylesheet" href="../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.e7340bb3dbd8dde6db86f25597f54a1b.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Datasets" href="../data/datasets.html" />
    <link rel="prev" title="Spatial Networks" href="07-Spatial_networks.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  
  <h1 class="site-logo" id="site-title">Geographic Data Science for Applied Economists</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../pages/home.html">
   Home
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Overview
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../pages/overview.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pages/infrastructure.html">
   Infrastructure
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Content
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="01-Introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02-Spatial_data.html">
   Spatial Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03-Geovisualisation.html">
   Geovisualisation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04-Spatial_feature_eng_i.html">
   Spatial Feature Engineering (I)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05-Spatial_feature_eng_ii.html">
   Spatial Feature Engineering (II)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06-OpenStreetMap.html">
   OpenStreetMap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07-Spatial_networks.html">
   Spatial Networks
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Transport costs
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Epilogue
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../data/datasets.html">
   Datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pages/further.html">
   Further Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../pages/z_bibliography.html">
   Bibliography
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/content/notebooks/08-Transport_costs.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                    title="Fullscreen mode"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/darribas/gds4ae/master?urlpath=tree/content/notebooks/08-Transport_costs.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i>
            Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ahead-of-time">
   📖 Ahead of time…
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hands-on-coding">
   💻 Hands-on coding
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#moving-along-street-networks">
     <em>
      Moving
     </em>
     along (street) networks
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#shortest-path-routing">
       Shortest-path routing
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#third-party-driven-routing">
       “Third party-driven” routing
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#proximity">
       Proximity
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#accessibility">
       Accessibility
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#moving-along-surfaces">
     <em>
      Moving
     </em>
     along surfaces
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Shortest-path routing
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#path-finding-on-friction-surfaces">
       Path-finding on friction surfaces
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#over-to-you">
     Over to you…
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#next-steps">
   🐾 Next steps
  </a>
 </li>
</ul>

        </nav>
        
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="transport-costs">
<h1>Transport costs<a class="headerlink" href="#transport-costs" title="Permalink to this headline">¶</a></h1>
<div class="section" id="ahead-of-time">
<h2>📖 Ahead of time…<a class="headerlink" href="#ahead-of-time" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="hands-on-coding">
<h2>💻 Hands-on coding<a class="headerlink" href="#hands-on-coding" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">momepy</span>
<span class="kn">import</span> <span class="nn">geopandas</span>
<span class="kn">import</span> <span class="nn">contextily</span>
<span class="kn">import</span> <span class="nn">xarray</span><span class="o">,</span> <span class="nn">rioxarray</span>
<span class="kn">import</span> <span class="nn">osmnx</span> <span class="k">as</span> <span class="nn">ox</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="moving-along-street-networks">
<h3><em>Moving</em> along (street) networks<a class="headerlink" href="#moving-along-street-networks" title="Permalink to this headline">¶</a></h3>
<div class="tabbed-set docutils">
<input checked="checked" id="33d864fe-fda4-4760-90f3-65aabe737206" name="5e4736ca-7dc6-4631-bc08-a39721581a8f" type="radio">
</input><label class="tabbed-label" for="33d864fe-fda4-4760-90f3-65aabe737206">
Local files</label><div class="tabbed-content docutils">
<p>Assuming you have the file locally on the path <code class="docutils literal notranslate"><span class="pre">../data/</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">streets</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../data/arturo_streets.gpkg&quot;</span><span class="p">)</span>
<span class="n">abbs</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../data/madrid_abb.gpkg&quot;</span><span class="p">)</span>
<span class="n">neis</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../data/neighbourhoods.geojson&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="34354a1f-28b2-4f95-afa1-6a1e4af6579a" name="5e4736ca-7dc6-4631-bc08-a39721581a8f" type="radio">
</input><label class="tabbed-label" for="34354a1f-28b2-4f95-afa1-6a1e4af6579a">
Online read</label><div class="tabbed-content docutils">
<p>If you’re online, you can do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">streets</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
    <span class="s2">&quot;https://darribas.org/gds4ae/_downloads/67d5480f98453027d59bf49606a7ad92/arturo_streets.gpkg&quot;</span>
<span class="p">)</span>
<span class="n">abbs</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
    <span class="s2">&quot;https://github.com/GDSL-UL/san/raw/v0.1.0/data/assignment_1_madrid/madrid_abb.gpkg&quot;</span>
<span class="p">)</span>
<span class="n">neis</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
    <span class="s2">&quot;http://darribas.org/gds4ae/_downloads/44b4bc22c042386c2c0f8dc6685ef17c/neighbourhoods.geojson&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">streets</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../data/arturo_streets.gpkg&quot;</span><span class="p">)</span>
<span class="n">abbs</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../data/madrid_abb.gpkg&quot;</span><span class="p">)</span>
<span class="n">neis</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../data/neighbourhoods.geojson&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/geopandas/geodataframe.py:577: RuntimeWarning: Sequential read of iterator was interrupted. Resetting iterator. This can negatively impact the performance.
  for feature in features_lst:
</pre></div>
</div>
</div>
</div>
<div class="section" id="shortest-path-routing">
<h4>Shortest-path routing<a class="headerlink" href="#shortest-path-routing" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandana</span>
</pre></div>
</div>
</div>
</div>
<p>Before building the routing network, we convert to graph and back in <code class="docutils literal notranslate"><span class="pre">momepy</span></code> to “clean” the network and ensure it complies with requirements for routing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">momepy</span><span class="o">.</span><span class="n">nx_to_gdf</span><span class="p">(</span>
    <span class="n">momepy</span><span class="o">.</span><span class="n">gdf_to_nx</span><span class="p">(</span>
        <span class="n">streets</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span> <span class="c1"># We &quot;explode&quot; to avoid multi-part rows</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;nodeID&quot;</span><span class="p">)</span> <span class="c1"># Reindex nodes on ID</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 4.12 s, sys: 61 ms, total: 4.19 s
Wall time: 4.19 s
</pre></div>
</div>
</div>
</div>
<p>Once we have nodes and edges “clean” from the graph representation, we can build a <code class="docutils literal notranslate"><span class="pre">pandana.Network</span></code> object we will use for routing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">streets_pdn</span> <span class="o">=</span> <span class="n">pandana</span><span class="o">.</span><span class="n">Network</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
    <span class="n">nodes</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
    <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;node_start&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;node_end&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="p">[[</span><span class="s2">&quot;mm_len&quot;</span><span class="p">]]</span>
<span class="p">)</span>

<span class="n">streets_pdn</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;pandana.network.Network at 0x7f9a87608340&gt;
</pre></div>
</div>
</div>
</div>
<p><em>How do I go from A to B?</em></p>
<p>For example, from the first Airbnb in the geo-table…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">first</span> <span class="o">=</span> <span class="n">abbs</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">streets</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>…to Puerta del Sol.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">geopy</span>
<span class="n">geopy</span><span class="o">.</span><span class="n">geocoders</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">default_user_agent</span> <span class="o">=</span> <span class="s2">&quot;gds4ae&quot;</span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">geocode</span><span class="p">(</span>
    <span class="s2">&quot;Puerta del Sol, Madrid&quot;</span><span class="p">,</span> <span class="n">geopy</span><span class="o">.</span><span class="n">Nominatim</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">streets</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">sol</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>address</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>POINT (440247.912 4474264.981)</td>
      <td>Puerta del Sol, Sol, Centro, Madrid, Área metr...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>First we snap locations to the network:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pt_nodes</span> <span class="o">=</span> <span class="n">streets_pdn</span><span class="o">.</span><span class="n">get_node_ids</span><span class="p">(</span>
    <span class="p">[</span><span class="n">first</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">],</span> 
    <span class="p">[</span><span class="n">first</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">sol</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">pt_nodes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0     3072
1    35732
Name: node_id, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Then we can route the shortest path:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">route_nodes</span> <span class="o">=</span> <span class="n">streets_pdn</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span>
    <span class="n">pt_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">route_nodes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 3072,  3477,  8269,  8267,  8268, 18696, 18694,  1433,  1431,
         354,  8176,  8177, 18122, 17477, 16859, 14323, 16858, 17811,
       44796, 41221, 41218, 41222, 41653, 18925, 18929, 48944, 18932,
       21095, 21096, 23220, 15399, 15400, 15401, 47447, 47448, 23277,
       47449, 23260, 23261, 23262, 27952, 27953, 27954, 48328, 11951,
       11950, 11945, 19476, 19477, 27334, 30089, 43295, 11941, 11942,
       11943, 48326, 37485, 48317, 15894, 15891, 15892, 29955, 25454,
        7342, 34992, 23609, 28218, 21649, 21650, 21652, 39076, 25109,
       25103, 25102, 25101, 48519, 47288, 34624, 31188, 29616, 48557,
       22845, 48554, 48556, 40923, 40922, 40924, 48586, 46373, 46372,
       46371, 45676, 45677, 38779, 38778, 19145, 20499, 20498, 20500,
       47738, 42304, 42303, 35731, 35728, 35730, 35732])
</pre></div>
</div>
</div>
</div>
<p>With this information, we can build the route line manually:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The code to generate the route involves writing a function and is a bit more advanced than expected for this course. If this looks too complicated, do not despair.</p>
<p>Also, please note this builds a <em>simplified</em> line for the route, not one that is based on the original geometries (distance calculations <em>are</em> based on the original network).</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">LineString</span>

<span class="k">def</span> <span class="nf">route_nodes_to_line</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">network</span><span class="p">):</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nodes</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;src_node&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;tgt_node&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]},</span>
        <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">LineString</span><span class="p">(</span><span class="n">pts</span><span class="o">.</span><span class="n">values</span><span class="p">)],</span>
        <span class="n">crs</span><span class="o">=</span><span class="n">streets</span><span class="o">.</span><span class="n">crs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
</pre></div>
</div>
</div>
</div>
<p>We can calculate the route:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">route</span> <span class="o">=</span> <span class="n">route_nodes_to_line</span><span class="p">(</span><span class="n">route_nodes</span><span class="p">,</span> <span class="n">streets_pdn</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_margin tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="../../_images/08-Transport_costs_26_0.png" src="../../_images/08-Transport_costs_26_0.png" />
</div>
</div>
<p>And we get it back as a geo-table (with one row):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">route</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>src_node</th>
      <th>tgt_node</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3072</td>
      <td>3477</td>
      <td>LINESTRING (442606.507 4478714.516, 442597.100...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>If we wanted to obtain the length of the route:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">route_len</span> <span class="o">=</span> <span class="n">streets_pdn</span><span class="o">.</span><span class="n">shortest_path_length</span><span class="p">(</span>
    <span class="n">pt_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pt_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="nb">round</span><span class="p">(</span><span class="n">route_len</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># Dist in Km</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5.514
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="third-party-driven-routing">
<h4>“Third party-driven” routing<a class="headerlink" href="#third-party-driven-routing" title="Permalink to this headline">¶</a></h4>
<p><em>How do I go from A to B trying to avoid Airbnb’s?</em></p>
<hr class="docutils" />
<p><strong>COMPLETE WITH EXAMPLE AVOIDING AIRBNB</strong></p>
</div>
<hr class="docutils" />
<div class="section" id="proximity">
<h4>Proximity<a class="headerlink" href="#proximity" title="Permalink to this headline">¶</a></h4>
<p><em>What is the nearest internet cafe for Airbnb’s without WiFi?</em></p>
<p>First we identify Airbnb’s without WiFi:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">no_wifi</span> <span class="o">=</span> <span class="n">abbs</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;WiFi == &#39;0&#39;&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">streets</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then pull WiFi spots in Madrid from OpenStreetMap:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">icafes</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">geometries_from_place</span><span class="p">(</span>
    <span class="s2">&quot;Madrid, Spain&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;amenity&quot;</span><span class="p">:</span> <span class="s2">&quot;internet_cafe&quot;</span><span class="p">}</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">streets</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">no_wifi</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> 
    <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Airbnb no WiFi&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">icafes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lime&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Internet cafes&quot;</span>
<span class="p">)</span>
<span class="n">contextily</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span> 
    <span class="n">crs</span><span class="o">=</span><span class="n">no_wifi</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
    <span class="n">source</span><span class="o">=</span><span class="n">contextily</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">CartoDB</span><span class="o">.</span><span class="n">Voyager</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/ipykernel/ipkernel.py:283: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
<img alt="../../_images/08-Transport_costs_40_1.png" src="../../_images/08-Transport_costs_40_1.png" />
</div>
</div>
<p>The logic for this operation is the following:</p>
<ol class="simple">
<li><p>Add the points of interest (POIs, the internet cafes) to the network object (<code class="docutils literal notranslate"><span class="pre">streets_pdn</span></code>)</p></li>
<li><p>Find the nearest node to each POI</p></li>
<li><p>Find the nearest node to each Airbnb without WiFi</p></li>
<li><p>Connect each Airbnb to its nearest internet cafe</p></li>
</ol>
<p>We can add the internet cafes to the network object (1.) with the <code class="docutils literal notranslate"><span class="pre">set_pois</span></code> method:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Note we set <code class="docutils literal notranslate"><span class="pre">max_items=1</span></code> because we are only going to query for the nearest cafe. This will make computations much faster</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">streets_pdn</span><span class="o">.</span><span class="n">set_pois</span><span class="p">(</span>
    <span class="n">category</span><span class="o">=</span><span class="s2">&quot;Internet cafes&quot;</span><span class="p">,</span>
    <span class="n">maxitems</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">maxdist</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="c1"># 100km so everything is included</span>
    <span class="n">x_col</span><span class="o">=</span><span class="n">icafes</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
    <span class="n">y_col</span><span class="o">=</span><span class="n">icafes</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/pandana/network.py:660: DeprecationWarning: The default dtype for empty Series will be &#39;object&#39; instead of &#39;float64&#39; in a future version. Specify a dtype explicitly to silence this warning.
  elif isinstance(maxitems, type(pd.Series())):
/opt/conda/lib/python3.8/site-packages/pandana/network.py:668: DeprecationWarning: The default dtype for empty Series will be &#39;object&#39; instead of &#39;float64&#39; in a future version. Specify a dtype explicitly to silence this warning.
  elif isinstance(maxdist, type(pd.Series())):
</pre></div>
</div>
</div>
</div>
<p>Once the cafes are added to the network, we can find the nearest one to each node (2.):</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Note there are some nodes for which we can’t find a nearest cafe. These are related to disconnected parts of the network</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cafe2nnode</span> <span class="o">=</span> <span class="n">streets_pdn</span><span class="o">.</span><span class="n">nearest_pois</span><span class="p">(</span>
    <span class="mi">100000</span><span class="p">,</span>              <span class="c1"># Max distance to look for</span>
    <span class="s2">&quot;Internet cafes&quot;</span><span class="p">,</span>    <span class="c1"># POIs to look for</span>
    <span class="n">num_pois</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>          <span class="c1"># No. of POIs to include</span>
    <span class="n">include_poi_ids</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Store POI ID</span>
<span class="c1"># Then add the internet cafee IDs and name</span>
<span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">icafes</span><span class="p">[[</span><span class="s2">&quot;unique_id&quot;</span><span class="p">,</span> <span class="s2">&quot;osmid&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">]],</span>
    <span class="n">on</span><span class="o">=</span><span class="s2">&quot;poi1&quot;</span>
<span class="c1"># Rename the distance from node to cafe</span>
<span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;dist2icafe&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">cafe2nnode</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 49985 entries, 1 to 49985
Data columns (total 5 columns):
 #   Column      Non-Null Count  Dtype  
---  ------      --------------  -----  
 0   dist2icafe  49985 non-null  float64
 1   poi1        49113 non-null  float64
 2   unique_id   49113 non-null  object 
 3   osmid       49113 non-null  float64
 4   name        25684 non-null  object 
dtypes: float64(3), object(2)
memory usage: 3.3+ MB
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/ipykernel/ipkernel.py:283: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
</div>
</div>
<p>Note that, to make things easier down the line, we can link <code class="docutils literal notranslate"><span class="pre">cafe2nnode</span></code> to the cafe IDs.</p>
<p>And we can also link Airbnb’s to nodes (3.) following a similar approach as we have seen above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">abbs_nnode</span> <span class="o">=</span> <span class="n">streets_pdn</span><span class="o">.</span><span class="n">get_node_ids</span><span class="p">(</span>
    <span class="n">no_wifi</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">no_wifi</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span>
<span class="p">)</span>
<span class="n">abbs_nnode</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/ipykernel/ipkernel.py:283: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>26      8873
50     10906
62     41159
63     34258
221    32216
Name: node_id, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>Finally, we can bring together both to find out what is the nearest internet cafe for each Airbnb (4.):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">abb_icafe</span> <span class="o">=</span> <span class="n">no_wifi</span><span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
<span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">nnode</span><span class="o">=</span><span class="n">abbs_nnode</span>
<span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">cafe2nnode</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;nnode&quot;</span>
<span class="p">)</span>
<span class="n">abb_icafe</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/ipykernel/ipkernel.py:283: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geometry</th>
      <th>nnode</th>
      <th>dist2icafe</th>
      <th>poi1</th>
      <th>unique_id</th>
      <th>osmid</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>26</th>
      <td>POINT (443128.256 4483599.841)</td>
      <td>8873</td>
      <td>4926.223145</td>
      <td>9.0</td>
      <td>node/3770327498</td>
      <td>3.770327e+09</td>
      <td>Silver Envíos 2</td>
    </tr>
    <tr>
      <th>50</th>
      <td>POINT (441885.677 4475916.602)</td>
      <td>10906</td>
      <td>1876.392944</td>
      <td>19.0</td>
      <td>node/6922981312</td>
      <td>6.922981e+09</td>
      <td>Locutorio</td>
    </tr>
    <tr>
      <th>62</th>
      <td>POINT (440439.640 4476480.771)</td>
      <td>41159</td>
      <td>1164.812988</td>
      <td>17.0</td>
      <td>node/5573414444</td>
      <td>5.573414e+09</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>63</th>
      <td>POINT (438485.311 4471714.377)</td>
      <td>34258</td>
      <td>1466.537964</td>
      <td>5.0</td>
      <td>node/2304484515</td>
      <td>2.304485e+09</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>221</th>
      <td>POINT (439941.104 4473117.914)</td>
      <td>32216</td>
      <td>354.268005</td>
      <td>15.0</td>
      <td>node/5412144560</td>
      <td>5.412145e+09</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="accessibility">
<h4>Accessibility<a class="headerlink" href="#accessibility" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">parks</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">geometries_from_place</span><span class="p">(</span>
    <span class="s2">&quot;Madrid, Spain&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;leisure&quot;</span><span class="p">:</span> <span class="s2">&quot;park&quot;</span><span class="p">}</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">streets</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 449 ms, sys: 7.98 ms, total: 457 ms
Wall time: 457 ms
</pre></div>
</div>
</div>
</div>
<p><em>How many parks are within 500m(-euclidean) of an Airbnb?</em></p>
<p>We draw a radious of 500m around each AirBnb:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buffers</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
    <span class="n">geometry</span><span class="o">=</span><span class="n">abbs</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
        <span class="n">streets</span><span class="o">.</span><span class="n">crs</span>
    <span class="p">)</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span>
        <span class="mi">500</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/ipykernel/ipkernel.py:283: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
</div>
</div>
<p>Then intersect it with the location of parks, and count by buffer (ie. Airbnb):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">park_count</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span>
    <span class="n">parks</span><span class="p">,</span> <span class="n">buffers</span>
<span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="s2">&quot;index_right&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/ipykernel/ipkernel.py:283: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
</div>
</div>
<p><em>How many parks are within 500m(-network) of an Airbnb?</em></p>
<p>We need to approach this as a calculation <em>within</em> the network. The logic of steps thus looks like:</p>
<ol class="simple">
<li><p>Use the aggregation module in <code class="docutils literal notranslate"><span class="pre">pandana</span></code> to count the number of parks within 500m of each node in the network</p></li>
<li><p>Extract the counts for the nodes nearest to Airbnb properties</p></li>
<li><p>Assign park counts to each Airbnb</p></li>
</ol>
<p>We can set up the aggregate engine (1.). This involves three steps:</p>
<p>a. Obtain nearest node for each park</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parks_nnode</span> <span class="o">=</span> <span class="n">streets_pdn</span><span class="o">.</span><span class="n">get_node_ids</span><span class="p">(</span>
    <span class="n">parks</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">parks</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>b. Insert the parks’ nearest node through <code class="docutils literal notranslate"><span class="pre">set</span></code> so it can be “aggregated”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">streets_pdn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">parks_nnode</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Parks&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>c. “Aggregate” for a distance of 500m, effectively counting the number of parks within 500m of each node</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parks_by_node</span> <span class="o">=</span> <span class="n">streets_pdn</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="n">distance</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Parks&quot;</span>
<span class="p">)</span>
<span class="n">parks_by_node</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>nodeID
1    5.0
2    5.0
3    6.0
4    8.0
5    1.0
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>At this point, we have the number of parks within 500m of <em>every</em> node in the network. To identify those that correspond to each Airbnb (3.), we query those nodes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">abbs_xys</span> <span class="o">=</span> <span class="n">abbs</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">streets</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span>
<span class="n">abbs_nnode</span> <span class="o">=</span> <span class="n">streets_pdn</span><span class="o">.</span><span class="n">get_node_ids</span><span class="p">(</span>
    <span class="n">abbs_xys</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">abbs_xys</span><span class="o">.</span><span class="n">y</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/ipykernel/ipkernel.py:283: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
</div>
</div>
<p>And use the list to asign the count of the nearest node to each Airbnb:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">park_count_network</span> <span class="o">=</span> <span class="n">abbs_nnode</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
    <span class="n">parks_by_node</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><em>For which areas do both differ most?</em></p>
<p>We can compare the two counts above to explore to what extent the street layout is constraining access to nearby parks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">park_comp</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;Euclidean&quot;</span><span class="p">:</span> <span class="n">park_count</span><span class="p">,</span> 
        <span class="s2">&quot;Network&quot;</span><span class="p">:</span> <span class="n">park_count_network</span>
    <span class="p">},</span>
    <span class="n">geometry</span><span class="o">=</span><span class="n">abbs</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
    <span class="n">crs</span><span class="o">=</span><span class="n">abbs</span><span class="o">.</span><span class="n">crs</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">park_comp</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="s2">&quot;Euclidean&quot;</span><span class="p">,</span> <span class="s2">&quot;Network&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/08-Transport_costs_73_0.png" src="../../_images/08-Transport_costs_73_0.png" />
</div>
</div>
<p>And, geographically:</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Note there are a few cases where there are more network counts than Euclidean. These are due to the slight inaccuracies introduced by calculating network distances from nodes rather than the locations themselves</p>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Euclidean count</span>
<span class="n">abbs</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
    <span class="n">streets</span><span class="o">.</span><span class="n">crs</span>
<span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">n_parks</span><span class="o">=</span><span class="n">park_count</span>
<span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="s2">&quot;n_parks&quot;</span><span class="p">,</span> 
    <span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;fisherjenkssampled&quot;</span><span class="p">,</span> 
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">contextily</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
    <span class="n">crs</span><span class="o">=</span><span class="n">streets</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
    <span class="n">source</span><span class="o">=</span><span class="n">contextily</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">CartoDB</span><span class="o">.</span><span class="n">PositronNoLabels</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Euclidean Distances&quot;</span><span class="p">)</span>

<span class="c1"># Count difference</span>
<span class="n">with_parks</span> <span class="o">=</span> <span class="n">park_comp</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;(Network &gt; 0) &amp; (Euclidean &gt; 0)&quot;</span>
<span class="p">)</span>
<span class="n">count_diff</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span>
    <span class="n">with_parks</span><span class="p">[</span><span class="s2">&quot;Euclidean&quot;</span><span class="p">]</span> <span class="o">-</span> 
    <span class="n">with_parks</span><span class="p">[</span><span class="s2">&quot;Network&quot;</span><span class="p">]</span>
<span class="p">)</span> <span class="o">/</span> <span class="n">with_parks</span><span class="p">[</span><span class="s2">&quot;Euclidean&quot;</span><span class="p">]</span>
<span class="n">abbs</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
    <span class="n">streets</span><span class="o">.</span><span class="n">crs</span>
<span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">n_parks</span><span class="o">=</span><span class="n">count_diff</span>
<span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="s2">&quot;n_parks&quot;</span><span class="p">,</span> 
    <span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;fisherjenkssampled&quot;</span><span class="p">,</span> 
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">contextily</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
    <span class="n">crs</span><span class="o">=</span><span class="n">streets</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
    <span class="n">source</span><span class="o">=</span><span class="n">contextily</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">CartoDB</span><span class="o">.</span><span class="n">PositronNoLabels</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Count Difference (%)&quot;</span><span class="p">)</span>

<span class="c1"># Network count</span>
<span class="n">abbs</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
    <span class="n">streets</span><span class="o">.</span><span class="n">crs</span>
<span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">n_parks</span><span class="o">=</span><span class="n">park_count_network</span>
<span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="s2">&quot;n_parks&quot;</span><span class="p">,</span> 
    <span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;fisherjenkssampled&quot;</span><span class="p">,</span> 
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
    <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">contextily</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> 
    <span class="n">crs</span><span class="o">=</span><span class="n">streets</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
    <span class="n">source</span><span class="o">=</span><span class="n">contextily</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">CartoDB</span><span class="o">.</span><span class="n">PositronNoLabels</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Network Distances&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/ipykernel/ipkernel.py:283: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
<img alt="../../_images/08-Transport_costs_75_1.png" src="../../_images/08-Transport_costs_75_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="moving-along-surfaces">
<h3><em>Moving</em> along surfaces<a class="headerlink" href="#moving-along-surfaces" title="Permalink to this headline">¶</a></h3>
<div class="tabbed-set docutils">
<input checked="checked" id="22c1e7af-bd58-4551-b642-b9056fef3a6e" name="795981da-556c-4576-9b1c-a4d0fb5b8244" type="radio">
</input><label class="tabbed-label" for="22c1e7af-bd58-4551-b642-b9056fef3a6e">
Local files</label><div class="tabbed-content docutils">
<p>Assuming you have the file locally on the path <code class="docutils literal notranslate"><span class="pre">../data/</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">friction_walk</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span>
    <span class="s2">&quot;../data/cambodia_2020_walking_friction_surface.tif&quot;</span>
<span class="p">)</span>
<span class="n">friction_motor</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span>
    <span class="s2">&quot;../data/cambodia_2020_motorized_friction_surface.tif&quot;</span>
<span class="p">)</span>
<span class="n">cities</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../data/cambodian_cities.geojson&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="543ade89-3777-400b-b41c-c3aa1bcb7aa5" name="795981da-556c-4576-9b1c-a4d0fb5b8244" type="radio">
</input><label class="tabbed-label" for="543ade89-3777-400b-b41c-c3aa1bcb7aa5">
Online read</label><div class="tabbed-content docutils">
<p>If you’re online, you can do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">friction_walk</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span>
    <span class="s2">&quot;https://darribas.org/gds4ae/_downloads/481f40ab3d2922d5e00b084b3668314b/cambodia_2020_walking_friction_surface.tif&quot;</span>
<span class="p">)</span>
<span class="n">friction_motor</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span>
    <span class="s2">&quot;https://darribas.org/gds4ae/_downloads/f41b238a4d072a8a3eb5ce1794cd126a/cambodia_2020_motorized_friction_surface.tif&quot;</span>
<span class="p">)</span>
<span class="n">cities</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
    <span class="s2">&quot;https://darribas.org/gds4ae/_downloads/b2bc4ad46ffb5fcec467286c022adf14/cambodian_cities.geojson&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">friction_walk</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span>
    <span class="s2">&quot;../data/cambodia_2020_walking_friction_surface.tif&quot;</span>
<span class="p">)</span>
<span class="n">friction_motor</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span>
    <span class="s2">&quot;../data/cambodia_2020_motorized_friction_surface.tif&quot;</span>
<span class="p">)</span>
<span class="n">cities</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../data/cambodian_cities.geojson&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id1">
<h4>Shortest-path routing<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="kn">import</span> <span class="nn">osmnx</span> <span class="k">as</span> <span class="nn">ox</span>

<span class="n">main_roads</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">geometries_from_place</span><span class="p">(</span>
    <span class="s2">&quot;Cambodia&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;highway&quot;</span><span class="p">:</span> <span class="s2">&quot;trunk&quot;</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 1min 2s, sys: 309 ms, total: 1min 2s
Wall time: 1min 2s
</pre></div>
</div>
</div>
</div>
<div class="cell tag_margin tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="../../_images/08-Transport_costs_81_0.png" src="../../_images/08-Transport_costs_81_0.png" />
</div>
</div>
<p>From the geo-table of roads, we can generate a surface that has a value of 1 on cells where a road crosses, and 0 otherwise (<em>rasterisation</em>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">geocube.api.core</span> <span class="kn">import</span> <span class="n">make_geocube</span>

<span class="n">roads_surface</span> <span class="o">=</span> <span class="n">make_geocube</span><span class="p">(</span>
    <span class="n">main_roads</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">one</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">3148</span><span class="p">),</span>
    <span class="n">measurements</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;one&quot;</span><span class="p">],</span>
    <span class="n">resolution</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="p">)[</span><span class="s2">&quot;one&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now we turn it into a binary mask:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">road_mask</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">roads_surface</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove-input tag_margin docutils container">
<div class="cell_output docutils container">
<img alt="../../_images/08-Transport_costs_86_0.png" src="../../_images/08-Transport_costs_86_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">road_mask</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray &#x27;one&#x27; (y: 745, x: 847)&gt;
array([[0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0],
       ...,
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0]])
Coordinates:
  * y            (y) float64 1.167e+06 1.168e+06 ... 1.539e+06 1.539e+06
  * x            (x) float64 2.348e+05 2.352e+05 ... 6.572e+05 6.578e+05
    spatial_ref  int64 0</pre><div class='xr-wrap' hidden><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'>'one'</div><ul class='xr-dim-list'><li><span class='xr-has-index'>y</span>: 745</li><li><span class='xr-has-index'>x</span>: 847</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-d1655eff-fe3c-4927-9e9b-128debdf53d3' class='xr-array-in' type='checkbox' checked><label for='section-d1655eff-fe3c-4927-9e9b-128debdf53d3' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ... 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</span></div><div class='xr-array-data'><pre>array([[0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0],
       ...,
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0]])</pre></div></div></li><li class='xr-section-item'><input id='section-25497146-2793-44bd-a597-2d6d2e5b572e' class='xr-section-summary-in' type='checkbox'  checked><label for='section-25497146-2793-44bd-a597-2d6d2e5b572e' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>y</span></div><div class='xr-var-dims'>(y)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.167e+06 1.168e+06 ... 1.539e+06</div><input id='attrs-c3a2b5d5-2b85-4f9b-9be1-d4259db60b55' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-c3a2b5d5-2b85-4f9b-9be1-d4259db60b55' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-e0e5c02d-6345-429c-989e-51f69e1ddc68' class='xr-var-data-in' type='checkbox'><label for='data-e0e5c02d-6345-429c-989e-51f69e1ddc68' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>axis :</span></dt><dd>Y</dd><dt><span>long_name :</span></dt><dd>y coordinate of projection</dd><dt><span>standard_name :</span></dt><dd>projection_y_coordinate</dd><dt><span>units :</span></dt><dd>metre</dd></dl></div><div class='xr-var-data'><pre>array([1167250., 1167750., 1168250., ..., 1538250., 1538750., 1539250.])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>x</span></div><div class='xr-var-dims'>(x)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>2.348e+05 2.352e+05 ... 6.578e+05</div><input id='attrs-b8a326c2-edee-47b9-85af-80d89149b2dc' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-b8a326c2-edee-47b9-85af-80d89149b2dc' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d82b6cce-0979-444d-ad55-4bab8bfc07a9' class='xr-var-data-in' type='checkbox'><label for='data-d82b6cce-0979-444d-ad55-4bab8bfc07a9' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>axis :</span></dt><dd>X</dd><dt><span>long_name :</span></dt><dd>x coordinate of projection</dd><dt><span>standard_name :</span></dt><dd>projection_x_coordinate</dd><dt><span>units :</span></dt><dd>metre</dd></dl></div><div class='xr-var-data'><pre>array([234750., 235250., 235750., ..., 656750., 657250., 657750.])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>spatial_ref</span></div><div class='xr-var-dims'>()</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0</div><input id='attrs-feb2569f-d4d9-483c-adc5-d0cf9be5ad73' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-feb2569f-d4d9-483c-adc5-d0cf9be5ad73' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-45c88be6-f24f-4d16-9e25-3445da84ea1c' class='xr-var-data-in' type='checkbox'><label for='data-45c88be6-f24f-4d16-9e25-3445da84ea1c' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>crs_wkt :</span></dt><dd>PROJCS[&quot;Indian 1960 / UTM zone 48N&quot;,GEOGCS[&quot;Indian 1960&quot;,DATUM[&quot;Indian_1960&quot;,SPHEROID[&quot;Everest 1830 (1937 Adjustment)&quot;,6377276.345,300.8017],AUTHORITY[&quot;EPSG&quot;,&quot;6131&quot;]],PRIMEM[&quot;Greenwich&quot;,0],UNIT[&quot;degree&quot;,0.0174532925199433,AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;4131&quot;]],PROJECTION[&quot;Transverse_Mercator&quot;],PARAMETER[&quot;latitude_of_origin&quot;,0],PARAMETER[&quot;central_meridian&quot;,105],PARAMETER[&quot;scale_factor&quot;,0.9996],PARAMETER[&quot;false_easting&quot;,500000],PARAMETER[&quot;false_northing&quot;,0],UNIT[&quot;metre&quot;,1],AXIS[&quot;Easting&quot;,EAST],AXIS[&quot;Northing&quot;,NORTH],AUTHORITY[&quot;EPSG&quot;,&quot;3148&quot;]]</dd><dt><span>semi_major_axis :</span></dt><dd>6377276.345</dd><dt><span>semi_minor_axis :</span></dt><dd>6356075.41314024</dd><dt><span>inverse_flattening :</span></dt><dd>300.8017</dd><dt><span>reference_ellipsoid_name :</span></dt><dd>Everest 1830 (1937 Adjustment)</dd><dt><span>longitude_of_prime_meridian :</span></dt><dd>0.0</dd><dt><span>prime_meridian_name :</span></dt><dd>Greenwich</dd><dt><span>geographic_crs_name :</span></dt><dd>Indian 1960</dd><dt><span>horizontal_datum_name :</span></dt><dd>Indian 1960</dd><dt><span>projected_crs_name :</span></dt><dd>Indian 1960 / UTM zone 48N</dd><dt><span>grid_mapping_name :</span></dt><dd>transverse_mercator</dd><dt><span>latitude_of_projection_origin :</span></dt><dd>0.0</dd><dt><span>longitude_of_central_meridian :</span></dt><dd>105.0</dd><dt><span>false_easting :</span></dt><dd>500000.0</dd><dt><span>false_northing :</span></dt><dd>0.0</dd><dt><span>scale_factor_at_central_meridian :</span></dt><dd>0.9996</dd><dt><span>spatial_ref :</span></dt><dd>PROJCS[&quot;Indian 1960 / UTM zone 48N&quot;,GEOGCS[&quot;Indian 1960&quot;,DATUM[&quot;Indian_1960&quot;,SPHEROID[&quot;Everest 1830 (1937 Adjustment)&quot;,6377276.345,300.8017],AUTHORITY[&quot;EPSG&quot;,&quot;6131&quot;]],PRIMEM[&quot;Greenwich&quot;,0],UNIT[&quot;degree&quot;,0.0174532925199433,AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;4131&quot;]],PROJECTION[&quot;Transverse_Mercator&quot;],PARAMETER[&quot;latitude_of_origin&quot;,0],PARAMETER[&quot;central_meridian&quot;,105],PARAMETER[&quot;scale_factor&quot;,0.9996],PARAMETER[&quot;false_easting&quot;,500000],PARAMETER[&quot;false_northing&quot;,0],UNIT[&quot;metre&quot;,1],AXIS[&quot;Easting&quot;,EAST],AXIS[&quot;Northing&quot;,NORTH],AUTHORITY[&quot;EPSG&quot;,&quot;3148&quot;]]</dd></dl></div><div class='xr-var-data'><pre>array(0)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-c484c9d7-5fe1-4f87-a11f-ed1cbacbdb7e' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-c484c9d7-5fe1-4f87-a11f-ed1cbacbdb7e' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
<p>Then we can generate the routing from, say Phnom Penh to Poipet, using <code class="docutils literal notranslate"><span class="pre">xarray-spatial</span></code>’s A* algorithm:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">xrspatial</span> <span class="kn">import</span> <span class="n">a_star_search</span>

<span class="c1"># Pull out starting point</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">cities</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;UC_NM_MN == &#39;Phnom Penh&#39;&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
    <span class="n">epsg</span><span class="o">=</span><span class="mi">3148</span>
<span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">geometry</span>

<span class="c1"># Pull out ending point</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">cities</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;UC_NM_MN == &#39;Poipet&#39;&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
    <span class="n">epsg</span><span class="o">=</span><span class="mi">3148</span>
<span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">geometry</span>

<span class="c1"># Routing</span>
<span class="n">route</span> <span class="o">=</span> <span class="n">a_star_search</span><span class="p">(</span>
    <span class="n">road_mask</span><span class="p">,</span>          <span class="c1"># Road surface</span>
    <span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="c1"># Starting point</span>
    <span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>     <span class="c1"># Destination point</span>
    <span class="n">barriers</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>       <span class="c1"># Cell values that cannot be crossed</span>
    <span class="n">snap_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>    <span class="c1"># Snap starting point to valid cells</span>
    <span class="n">snap_goal</span><span class="o">=</span><span class="kc">True</span>      <span class="c1"># Snap ending point to valid cells</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_margin tag_remove-input docutils container">
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.collections.QuadMesh at 0x7f0b7534b6a0&gt;
</pre></div>
</div>
<img alt="../../_images/08-Transport_costs_90_1.png" src="../../_images/08-Transport_costs_90_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">route</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2 {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray (y: 745, x: 847)&gt;
array([[nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan],
       ...,
       [nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan]])
Coordinates:
  * y            (y) float64 1.167e+06 1.168e+06 ... 1.539e+06 1.539e+06
  * x            (x) float64 2.348e+05 2.352e+05 ... 6.572e+05 6.578e+05
    spatial_ref  int64 0</pre><div class='xr-wrap' hidden><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'></div><ul class='xr-dim-list'><li><span class='xr-has-index'>y</span>: 745</li><li><span class='xr-has-index'>x</span>: 847</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-852be776-99f5-4d61-8d08-6846c78fbe80' class='xr-array-in' type='checkbox' checked><label for='section-852be776-99f5-4d61-8d08-6846c78fbe80' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>nan nan nan nan nan nan nan nan ... nan nan nan nan nan nan nan nan</span></div><div class='xr-array-data'><pre>array([[nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan],
       ...,
       [nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan],
       [nan, nan, nan, ..., nan, nan, nan]])</pre></div></div></li><li class='xr-section-item'><input id='section-11513306-7318-48d5-a59d-e81e59cc8408' class='xr-section-summary-in' type='checkbox'  checked><label for='section-11513306-7318-48d5-a59d-e81e59cc8408' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>y</span></div><div class='xr-var-dims'>(y)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.167e+06 1.168e+06 ... 1.539e+06</div><input id='attrs-90abf9e1-2bc2-4f1b-a19e-a030201bd73f' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-90abf9e1-2bc2-4f1b-a19e-a030201bd73f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d66189d8-28de-4b49-9a47-19cbe484a616' class='xr-var-data-in' type='checkbox'><label for='data-d66189d8-28de-4b49-9a47-19cbe484a616' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>axis :</span></dt><dd>Y</dd><dt><span>long_name :</span></dt><dd>y coordinate of projection</dd><dt><span>standard_name :</span></dt><dd>projection_y_coordinate</dd><dt><span>units :</span></dt><dd>metre</dd></dl></div><div class='xr-var-data'><pre>array([1167250., 1167750., 1168250., ..., 1538250., 1538750., 1539250.])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>x</span></div><div class='xr-var-dims'>(x)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>2.348e+05 2.352e+05 ... 6.578e+05</div><input id='attrs-8c80bb9d-2578-46cc-a7cc-c8a507be0cf1' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-8c80bb9d-2578-46cc-a7cc-c8a507be0cf1' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f84f8ef8-e6fc-495e-979e-d7541a72aec3' class='xr-var-data-in' type='checkbox'><label for='data-f84f8ef8-e6fc-495e-979e-d7541a72aec3' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>axis :</span></dt><dd>X</dd><dt><span>long_name :</span></dt><dd>x coordinate of projection</dd><dt><span>standard_name :</span></dt><dd>projection_x_coordinate</dd><dt><span>units :</span></dt><dd>metre</dd></dl></div><div class='xr-var-data'><pre>array([234750., 235250., 235750., ..., 656750., 657250., 657750.])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>spatial_ref</span></div><div class='xr-var-dims'>()</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0</div><input id='attrs-85aa0ff1-6ba4-4441-8385-20989a315a60' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-85aa0ff1-6ba4-4441-8385-20989a315a60' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-774125b1-a1bf-4c2f-b829-1f347ff4e676' class='xr-var-data-in' type='checkbox'><label for='data-774125b1-a1bf-4c2f-b829-1f347ff4e676' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>crs_wkt :</span></dt><dd>PROJCS[&quot;Indian 1960 / UTM zone 48N&quot;,GEOGCS[&quot;Indian 1960&quot;,DATUM[&quot;Indian_1960&quot;,SPHEROID[&quot;Everest 1830 (1937 Adjustment)&quot;,6377276.345,300.8017],AUTHORITY[&quot;EPSG&quot;,&quot;6131&quot;]],PRIMEM[&quot;Greenwich&quot;,0],UNIT[&quot;degree&quot;,0.0174532925199433,AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;4131&quot;]],PROJECTION[&quot;Transverse_Mercator&quot;],PARAMETER[&quot;latitude_of_origin&quot;,0],PARAMETER[&quot;central_meridian&quot;,105],PARAMETER[&quot;scale_factor&quot;,0.9996],PARAMETER[&quot;false_easting&quot;,500000],PARAMETER[&quot;false_northing&quot;,0],UNIT[&quot;metre&quot;,1],AXIS[&quot;Easting&quot;,EAST],AXIS[&quot;Northing&quot;,NORTH],AUTHORITY[&quot;EPSG&quot;,&quot;3148&quot;]]</dd><dt><span>semi_major_axis :</span></dt><dd>6377276.345</dd><dt><span>semi_minor_axis :</span></dt><dd>6356075.41314024</dd><dt><span>inverse_flattening :</span></dt><dd>300.8017</dd><dt><span>reference_ellipsoid_name :</span></dt><dd>Everest 1830 (1937 Adjustment)</dd><dt><span>longitude_of_prime_meridian :</span></dt><dd>0.0</dd><dt><span>prime_meridian_name :</span></dt><dd>Greenwich</dd><dt><span>geographic_crs_name :</span></dt><dd>Indian 1960</dd><dt><span>horizontal_datum_name :</span></dt><dd>Indian 1960</dd><dt><span>projected_crs_name :</span></dt><dd>Indian 1960 / UTM zone 48N</dd><dt><span>grid_mapping_name :</span></dt><dd>transverse_mercator</dd><dt><span>latitude_of_projection_origin :</span></dt><dd>0.0</dd><dt><span>longitude_of_central_meridian :</span></dt><dd>105.0</dd><dt><span>false_easting :</span></dt><dd>500000.0</dd><dt><span>false_northing :</span></dt><dd>0.0</dd><dt><span>scale_factor_at_central_meridian :</span></dt><dd>0.9996</dd><dt><span>spatial_ref :</span></dt><dd>PROJCS[&quot;Indian 1960 / UTM zone 48N&quot;,GEOGCS[&quot;Indian 1960&quot;,DATUM[&quot;Indian_1960&quot;,SPHEROID[&quot;Everest 1830 (1937 Adjustment)&quot;,6377276.345,300.8017],AUTHORITY[&quot;EPSG&quot;,&quot;6131&quot;]],PRIMEM[&quot;Greenwich&quot;,0],UNIT[&quot;degree&quot;,0.0174532925199433,AUTHORITY[&quot;EPSG&quot;,&quot;9122&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;4131&quot;]],PROJECTION[&quot;Transverse_Mercator&quot;],PARAMETER[&quot;latitude_of_origin&quot;,0],PARAMETER[&quot;central_meridian&quot;,105],PARAMETER[&quot;scale_factor&quot;,0.9996],PARAMETER[&quot;false_easting&quot;,500000],PARAMETER[&quot;false_northing&quot;,0],UNIT[&quot;metre&quot;,1],AXIS[&quot;Easting&quot;,EAST],AXIS[&quot;Northing&quot;,NORTH],AUTHORITY[&quot;EPSG&quot;,&quot;3148&quot;]]</dd></dl></div><div class='xr-var-data'><pre>array(0)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-7964f242-ff5e-433c-bab5-a6555646afcb' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-7964f242-ff5e-433c-bab5-a6555646afcb' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
<p>And we can turn the route surface into a line that connects the pixels in the route:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">LineString</span>

<span class="n">route_line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span>
    <span class="n">route</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;order&quot;</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
        <span class="s2">&quot;order&quot;</span>
    <span class="p">)[</span>
        <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
<span class="n">route_line</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/08-Transport_costs_93_0.svg" src="../../_images/08-Transport_costs_93_0.svg" /></div>
</div>
</div>
<div class="section" id="path-finding-on-friction-surfaces">
<h4>Path-finding on friction surfaces<a class="headerlink" href="#path-finding-on-friction-surfaces" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">friction_motor</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/08-Transport_costs_95_0.png" src="../../_images/08-Transport_costs_95_0.png" />
</div>
</div>
<p>We can use the same approach but taking full advantage of the power of surfaces to be detailed and fine grained. Instead of enforcing the route to take place along the limited number of pixels that cover a road, we can try to find a route that minimises friction.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set surface up</span>
<span class="n">surface</span> <span class="o">=</span> <span class="n">friction_motor</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">friction_motor</span><span class="o">!=</span><span class="n">friction_motor</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>
<span class="p">)</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="mi">3148</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
    <span class="n">band</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="c1"># Swap nodata value for N/A</span>
<span class="n">surface</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">surface</span><span class="o">!=</span><span class="n">surface</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">nodata</span>
<span class="p">)</span>
<span class="c1"># Swap order of Y coordinate</span>
<span class="n">surface</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Pull out starting point</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">cities</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;UC_NM_MN == &#39;Siem Reap&#39;&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
    <span class="n">epsg</span><span class="o">=</span><span class="mi">3148</span>
<span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">geometry</span>

<span class="c1"># Pull out ending point</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">cities</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
    <span class="s2">&quot;UC_NM_MN == &#39;Sihanoukville&#39;&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span>
    <span class="n">epsg</span><span class="o">=</span><span class="mi">3148</span>
<span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">geometry</span>

<span class="c1"># Routing</span>
<span class="n">route</span> <span class="o">=</span> <span class="n">a_star_search</span><span class="p">(</span>
    <span class="o">-</span><span class="n">surface</span><span class="p">,</span>            <span class="c1"># (Reprojected) road surface</span>
    <span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="c1"># Starting point</span>
    <span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>     <span class="c1"># Destination point</span>
<span class="p">)</span>

<span class="c1"># Swap order of Y coordinate back</span>
<span class="n">surface</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># Parse route into line</span>
<span class="n">route_line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span>
    <span class="n">route</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;order&quot;</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
        <span class="s2">&quot;order&quot;</span>
    <span class="p">)[</span>
        <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="p">)</span>
<span class="n">route_line</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">([</span><span class="n">route_line</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/conda/lib/python3.8/site-packages/ipykernel/ipkernel.py:283: DeprecationWarning: `should_run_async` will not call `transform_cell` automatically in the future. Please pass the result to `transformed_cell` argument and any exception that happen during thetransform in `preprocessing_exc_tuple` in IPython 7.17 and above.
  and should_run_async(code)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">surface</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">route_line</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/08-Transport_costs_98_0.png" src="../../_images/08-Transport_costs_98_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="over-to-you">
<h3>Over to you…<a class="headerlink" href="#over-to-you" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="next-steps">
<h2>🐾 Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">¶</a></h2>
<p>If you found the content in this block useful, the following resources represent some suggestions on where to go next:</p>
<ul class="simple">
<li><p>The <a class="reference external" href="https://github.com/UDST/pandana/blob/master/examples/Pandana-demo.ipynb"><code class="docutils literal notranslate"><span class="pre">pandana</span></code> tutorial</a> and <a class="reference external" href="http://udst.github.io/pandana/index.html">documentation</a> are excellent places to get a more detailed and comprehensive view into the functionality of the library</p></li>
<li><p>More about <code class="docutils literal notranslate"><span class="pre">xarray-spatial</span></code>, the library that provides geospatial techniques on top of surfaces is available at the project’s <a class="reference external" href="https://makepath.github.io/xarray-spatial/">documentation</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./content/notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="07-Spatial_networks.html" title="previous page">Spatial Networks</a>
    <a class='right-next' id="next-link" href="../data/datasets.html" title="next page">Datasets</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Dani Arribas-Bel & Diego Puga<br/>
        
          <div class="extra_footer">
            <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Data Science Studio</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://darribas.org" property="cc:attributionName" rel="cc:attributionURL">Dani Arribas-Bel</a> and <a xmlns:cc="http://creativecommons.org/ns#" href="https://diegopuga.org/" property="cc:attributionName" rel="cc:attributionURL">Diego Puga</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.

          </div>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../_static/js/index.d3f166471bb80abb5163.js"></script>


    
    <!-- Google Analytics -->
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-6032674-1', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->
    
  </body>
</html>